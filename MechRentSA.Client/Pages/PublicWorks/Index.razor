@page "/obras-publicas"

@inject HttpClient Http
@using MechRentSA.Shared;
@using CurrieTechnologies.Razor.SweetAlert2;
@using MechRentSA.Client.Interfaces;
@inject IJSRuntime JS
@inject SweetAlertService Swal;
@inject IPublicWorkService publicWorkService;
@inject IExcavatorService excavatorService;

<PageTitle>Obras públicas</PageTitle>

<h1>Obras públicas</h1>

<a class="btn btn-success btn-sm mb-3" href="obra-publica">Nueva obra pública</a>

<div class="d-flex align-items-center mb-3">
    <InputText class="form-control mr-2" @bind-Value="searchTerm" placeholder="Buscar por nombre de obra pública" />
    <button class="btn btn-primary" @onclick="SearchPublicWorks">Buscar</button>
</div>

<div class="table-responsive max-h-650">
    <table class="table table-sm table-hover table-bordered table-condensed">
        <thead>
            <tr>
                <th>Id</th>
                <th>Nombre</th>
                <th>Horas estimadas</th>
                <th>Retroexcavadoras</th>
                <th>Opciones</th>
            </tr>
        </thead>
        <tbody>
            @if (listPublicWork == null || !listPublicWork.Any())
            {
                <tr>
                    <td colspan="5">Sin datos asociados</td>
                </tr>
            }
            else
            {
                @foreach (var item in listPublicWork)
                {
                    <tr class="text-center">
                        <td>@item.Id</td>
                        <td>@item.Name</td>
                        <td>@item.EstimatedHours</td>
                        <td>
                            <ul>
                                @foreach (var excavator in item.ExcavatorWorkLogs.Select(e => e.ExcavatorDTO))
                                {
                                    <li>@excavator.Type</li>
                                }
                            </ul>
                        </td>
                        <td>
                            <div class="btn-group">
                                <a class="btn btn-warning btn-sm" href="obra-publica/@item.Id">Editar</a>
                                <button type="button" class="btn btn-danger btn-sm ms-2" @onclick="(() => Delete(item.Id))">Eliminar</button>
                            </div>
                        </td>
                    </tr>
                }
            }
        </tbody>
    </table>
</div>

<div class="d-flex justify-content-between mt-3">
    <button class="btn btn-primary btn-sm" @onclick="PreviousPage" disabled="@(!HasPreviousPage)">Anterior</button>
    <button class="btn btn-primary btn-sm" @onclick="NextPage" disabled="@(!HasNextPage)">Siguiente</button>
</div>

@code {
    List<PublicWorkDTO>? listPublicWork = null;
    string searchTerm = string.Empty;
    int currentPage = 1;
    int totalPages = 1;
    int pageSize = 2;
    int totalItems = 0;

    protected override async Task OnInitializedAsync()
    {
        await LoadPublicWorks();
    }

    private async Task LoadPublicWorks()
    {
        var response = await publicWorkService.GetPublicWorks(searchTerm, currentPage, pageSize);
        listPublicWork = response.Items ?? new List<PublicWorkDTO>();
        totalItems = response.TotalItems;
        totalPages = (int)Math.Ceiling((double)totalItems / pageSize);
    }

    private async Task SearchPublicWorks()
    {
        currentPage = 1;
        await LoadPublicWorks();
    }

    private async Task NextPage()
    {
        if (currentPage < totalPages)
        {
            currentPage++;
            await LoadPublicWorks();
        }
    }

    private async Task PreviousPage()
    {
        if (currentPage > 1)
        {
            currentPage--;
            await LoadPublicWorks();
        }
    }

    private bool HasPreviousPage => currentPage > 1;
    private bool HasNextPage => currentPage < totalPages;

    private async Task Delete(int id)
    {
        var result = await Swal.FireAsync(new SweetAlertOptions
            {
                Title = "Eliminar obra pública",
                Text = "¿Está seguro(a) de realizar esta acción?",
                Icon = SweetAlertIcon.Question,
                ShowCancelButton = true
            });

        if (result.IsConfirmed)
        {
            try
            {
                var response = await publicWorkService.DeletePublicWork(id);
                if (response.IsSuccessful)
                {
                    listPublicWork = listPublicWork!.FindAll(e => e.Id != id);
                    await Swal.FireAsync(new SweetAlertOptions
                        {
                            Title = "Éxito",
                            Text = "La obra pública ha sido eliminada con éxito.",
                            Icon = SweetAlertIcon.Success,
                            Timer = 2000 // Se cierra automáticamente después de 2 segundos
                        });
                    await JS.InvokeVoidAsync("logToConsole", $"Obra pública con Id {id} eliminada con éxito.");
                }
                else
                {
                    await Swal.FireAsync(new SweetAlertOptions
                        {
                            Title = "Error",
                            Text = response.Message,
                            Icon = SweetAlertIcon.Error,
                            Timer = 3000 // Se cierra automáticamente después de 3 segundos
                        });
                    await JS.InvokeVoidAsync("logToConsole", $"Error al eliminar la obra pública con Id {id}: {response.Message}");
                }
            }
            catch (Exception ex)
            {
                await Swal.FireAsync(new SweetAlertOptions
                    {
                        Title = "Error",
                        Text = ex.Message,
                        Icon = SweetAlertIcon.Error,
                        Timer = 3000 // Se cierra automáticamente después de 3 segundos
                    });
                await JS.InvokeVoidAsync("logToConsole", $"Error al eliminar la obra pública con Id {id}: {ex.Message}");
            }
        }
    }
}
