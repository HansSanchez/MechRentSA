@page "/excavadoras"

@inject HttpClient Http

@using MechRentSA.Shared;
@using CurrieTechnologies.Razor.SweetAlert2;
@using MechRentSA.Client.Interfaces;
@inject IJSRuntime JS

@inject SweetAlertService Swal;
@inject IExcavatorService excavatorService;

<PageTitle>Excavadoras</PageTitle>

<h1>Excavadoras</h1>

<a class="btn btn-success btn-sm mb-3" href="excavadora">Nueva excavadora</a>

<div class="d-flex align-items-center mb-3">
    <InputText class="form-control mr-2" @bind-Value="searchTerm" placeholder="Buscar por tipo de maquina" />
    <button class="btn btn-primary" @onclick="SearchExcavators">Buscar</button>
</div>

<div class="table-responsive max-h-650">
    <table class="table table-sm table-hover table-bordered table-condensed">
        <thead>
            <tr>
                <th>Id</th>
                <th>Tipo</th>
                <th>Costo por hora</th>
                <th>Intervalo de mantenimiento en horas</th>
                <th>Total de horas trabajadas</th>
                <th>Último mantenimiento</th>
                <th>Opciones</th>
            </tr>
        </thead>
        <tbody>
            @if (listExcavator == null || !listExcavator.Any())
            {
                <tr>
                    <td colspan="7">Sin datos asociados</td>
                </tr>
            }
            else
            {
                @foreach (var item in listExcavator)
                {
                    <tr class="text-center">
                        <td>@item.Id</td>
                        <td>@item.Type</td>
                        <td>@item.HourlyRate.ToString("C", new System.Globalization.CultureInfo("es-CO"))</td>
                        <td>@item.MaintenanceInterval</td>
                        <td>@item.TotalHoursWorked</td>
                        <td>@item.LastMaintenanceHours</td>
                        <td>
                            <div class="btn-group">
                                <a class="btn btn-warning btn-sm" href="excavadora/@item.Id">Editar</a>
                                <button type="button" class="btn btn-danger btn-sm ms-2" @onclick="(() => Delete(item.Id))">Eliminar</button>
                            </div>
                        </td>
                    </tr>
                }
            }
        </tbody>
    </table>
</div>

<div class="d-flex justify-content-between mt-3">
    <button class="btn btn-primary btn-sm" @onclick="PreviousPage" disabled="@(!HasPreviousPage)">Anterior</button>
    <button class="btn btn-primary btn-sm" @onclick="NextPage" disabled="@(!HasNextPage)">Siguiente</button>
</div>

@code {
    List<ExcavatorDTO>? listExcavator = null;
    string searchTerm = string.Empty;
    int currentPage = 1;
    int totalPages = 1;
    int pageSize = 2;
    int totalItems = 0;

    protected override async Task OnInitializedAsync()
    {
        await LoadExcavators();
    }

    private async Task LoadExcavators()
    {
        var response = await excavatorService.GetExcavators(searchTerm, currentPage, pageSize);
        listExcavator = response.Items ?? new List<ExcavatorDTO>();
        totalItems = response.TotalItems;
        totalPages = (int)Math.Ceiling((double)totalItems / pageSize);
    }

    private async Task SearchExcavators()
    {
        currentPage = 1;
        await LoadExcavators();
    }

    private async Task NextPage()
    {
        if (currentPage < totalPages)
        {
            currentPage++;
            await LoadExcavators();
        }
    }

    private async Task PreviousPage()
    {
        if (currentPage > 1)
        {
            currentPage--;
            await LoadExcavators();
        }
    }

    private bool HasPreviousPage => currentPage > 1;
    private bool HasNextPage => currentPage < totalPages;

    private async Task Delete(int id)
    {
        var result = await Swal.FireAsync(new SweetAlertOptions
            {
                Title = "Eliminar excavadora",
                Text = "¿Está seguro(a) de realizar esta acción?",
                Icon = SweetAlertIcon.Question,
                ShowCancelButton = true
            });

        if (result.IsConfirmed)
        {
            try
            {
                var response = await excavatorService.DeleteExcavator(id);
                if (response.IsSuccessful)
                {
                    listExcavator = listExcavator!.FindAll(e => e.Id != id);
                    await Swal.FireAsync(new SweetAlertOptions
                        {
                            Title = "Éxito",
                            Text = "La excavadora ha sido eliminada con éxito.",
                            Icon = SweetAlertIcon.Success,
                            Timer = 2000 // Se cierra automáticamente después de 2 segundos
                        });
                    await JS.InvokeVoidAsync("logToConsole", $"Excavadora con Id {id} eliminada con éxito.");
                }
                else
                {
                    await Swal.FireAsync(new SweetAlertOptions
                        {
                            Title = "Error",
                            Text = response.Message,
                            Icon = SweetAlertIcon.Error,
                            Timer = 3000 // Se cierra automáticamente después de 3 segundos
                        });
                    await JS.InvokeVoidAsync("logToConsole", $"Error al eliminar la excavadora con Id {id}: {response.Message}");
                }
            }
            catch (Exception ex)
            {
                await Swal.FireAsync(new SweetAlertOptions
                    {
                        Title = "Error",
                        Text = ex.Message,
                        Icon = SweetAlertIcon.Error,
                        Timer = 3000 // Se cierra automáticamente después de 3 segundos
                    });
                await JS.InvokeVoidAsync("logToConsole", $"Error al eliminar la excavadora con Id {id}: {ex.Message}");
            }
        }
    }
}
